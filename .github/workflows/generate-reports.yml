name: Generate Analysis Reports

on:
  schedule:
    - cron: "0 8 * * 5" # Friday at 08:00 UTC (16:00 HKT)
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days of data to download (default: 90, report shows ~83 days after 7-day warmup)'
        required: false
        default: '90'

permissions:
  contents: write

env:
  TZ: America/New_York

jobs:
  generate-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-analysis.txt

      - name: Create data directory
        run: mkdir -p data/kalshi_trades

      - name: Check disk space
        run: df -h

      - name: Download trade data from releases
        run: |
          DAYS_BACK="${{ github.event.inputs.days_back || '90' }}"
          echo "Downloading last $DAYS_BACK days of data..."
          
          # Get list of data releases
          RELEASES=$(gh release list --limit 200 --json tagName -q '.[].tagName' | grep '^data-' | sort -r | head -n "$DAYS_BACK")
          
          if [[ -z "$RELEASES" ]]; then
            echo "No data releases found. Running with available data."
            exit 0
          fi
          
          for TAG in $RELEASES; do
            DATE_STR="${TAG#data-}"
            ARCHIVE_NAME="kalshi_trades_${DATE_STR}.tar.gz"
            
            echo "Downloading $TAG..."
            gh release download "$TAG" -p "$ARCHIVE_NAME" -D data/kalshi_trades 2>/dev/null || continue
            
            # Extract and immediately delete archive to save space
            cd data/kalshi_trades
            tar -xzf "$ARCHIVE_NAME" 2>/dev/null || true
            rm -f "$ARCHIVE_NAME"
            # Remove macOS resource fork files if present
            rm -f ._*.json 2>/dev/null || true
            cd ../..
          done
          
          echo "Downloaded files:"
          ls -lh data/kalshi_trades/*.json 2>/dev/null | wc -l
          du -sh data/kalshi_trades/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate reports
        run: |
          export KALSHI_ROOT_DIR="${{ github.workspace }}"
          export KALSHI_DATA_DIR="${{ github.workspace }}/data/kalshi_trades"
          
          # Create output directories
          mkdir -p analysis/runs
          
          # Run the analysis
          PYTHON_BIN=python ./analysis/update_plots.sh

      - name: Prepare report artifacts
        id: prepare
        run: |
          # Find the latest run directory
          LATEST_RUN=$(ls -1d analysis/runs/*/ 2>/dev/null | sort -r | head -1)
          
          if [[ -n "$LATEST_RUN" ]]; then
            echo "run_dir=$LATEST_RUN" >> $GITHUB_OUTPUT
            echo "has_reports=true" >> $GITHUB_OUTPUT
            
            # Get report date from directory name
            REPORT_DATE=$(basename "$LATEST_RUN" | cut -d'_' -f1)
            echo "report_date=$REPORT_DATE" >> $GITHUB_OUTPUT
            echo "release_tag=report-$REPORT_DATE" >> $GITHUB_OUTPUT
            
            cd "$LATEST_RUN"
            zip -r "../report_${REPORT_DATE}.zip" . 2>/dev/null || true
            cd -
            
            echo "## Report Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Report date: $REPORT_DATE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Files generated:" >> $GITHUB_STEP_SUMMARY
            ls -1 "$LATEST_RUN" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_reports=false" >> $GITHUB_OUTPUT
            echo "No reports generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload report artifacts
        if: steps.prepare.outputs.has_reports == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kalshi-analysis-report-${{ steps.prepare.outputs.report_date }}
          path: |
            ${{ steps.prepare.outputs.run_dir }}
          retention-days: 30

      - name: Create GitHub Release with report images
        if: steps.prepare.outputs.has_reports == 'true'
        run: |
          RELEASE_TAG="${{ steps.prepare.outputs.release_tag }}"
          REPORT_DATE="${{ steps.prepare.outputs.report_date }}"
          RUN_DIR="${{ steps.prepare.outputs.run_dir }}"
          
          # Delete existing release if exists
          gh release delete "$RELEASE_TAG" --yes 2>/dev/null || true
          
          # Create new release with images
          gh release create "$RELEASE_TAG" \
            --title "Weekly Report: $REPORT_DATE" \
            --notes "Kalshi weekly analysis report for $REPORT_DATE" \
            "$RUN_DIR/7d_rolling_total_volume.png" \
            "$RUN_DIR/top_10_market_types_7d_ma.png" \
            "$RUN_DIR/daily_total_volume_python.csv" \
            "$RUN_DIR/daily_category_volume.csv"
          
          echo "âœ… Release created: $RELEASE_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Lark notification
        if: steps.prepare.outputs.has_reports == 'true'
        run: |
          python scripts/send_lark_notification.py \
            "${{ steps.prepare.outputs.report_date }}" \
            "${{ steps.prepare.outputs.release_tag }}"
        env:
          LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
